<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QA Agrotis System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* [Seção CSS: Mantida inalterada para garantir a interface web] */
        /* --- CSS RESET & BASE --- */
        :root { 
            --primary: #059669; --primary-dark: #047857; --primary-light: #d1fae5;
            --dark: #064e3b; --bg-light: #f0fdf4; --text: #334155; 
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --sidebar-width: 260px; --sidebar-collapsed: 70px; --header-height: 60px;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; display: flex; height: 100vh; background: var(--bg-light); color: var(--text); overflow: hidden; }
        
        /* --- LAYOUT DESKTOP --- */
        #mobile-header { display: none; }
        #sidebar { width: var(--sidebar-width); background: var(--dark); color: white; display: flex; flex-direction: column; transition: 0.3s; white-space: nowrap; z-index: 1000; height: 100vh; flex-shrink: 0; }
        #sidebar.collapsed { width: var(--sidebar-collapsed); }
        /* Ajuste para que o logo SVG não desapareça, mas apenas o texto */
        #sidebar.collapsed .brand span { display: none; }
        #sidebar.collapsed .menu li span, #sidebar.collapsed .user-info { display: none; }
        
        .brand { padding: 0 20px; height: 70px; font-size: 1.3rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; color: #6ee7b7; }
        .toggle-btn { cursor: pointer; padding: 10px; } 

        .menu { list-style: none; padding: 0; margin: 20px 0; flex-grow: 1; overflow-y: auto; }
        .menu li { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; color: #a7f3d0; border-left: 4px solid transparent; }
        .menu li:hover, .menu li.active { background: rgba(255,255,255,0.1); color: white; border-left-color: var(--success); }
        
        /* Estilização para o item Sair */
        #menu-logout { color: #fecaca; } /* Cor Vermelha Clara */
        #menu-logout:hover { background: rgba(239, 68, 68, 0.2); color: #fee2e2; border-left-color: var(--danger); }

        .user-panel { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; cursor: pointer; background: rgba(0,0,0,0.2); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); object-fit: cover; border: 2px solid var(--primary-light); }
        
        #main { flex-grow: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; position: relative; width: 100%; }
        .hidden { display: none !important; }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #mobile-header { display: flex; align-items: center; justify-content: space-between; background: var(--dark); color: white; padding: 0 20px; height: var(--header-height); flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
            #sidebar { position: fixed; top: 0; left: -100%; width: 280px; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.5); transition: left 0.3s ease; }
            #sidebar.mobile-open { left: 0; }
            #sidebar .toggle-btn { display: none; }
            #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(2px); }
            #sidebar-overlay.show { display: block; }
            
            #main { padding: 15px; padding-bottom: 80px; }
            .dash-grid, .grid-2-cols { grid-template-columns: 1fr !important; gap: 15px; }
            .dash-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .filter-group { width: 100%; flex-direction: column; align-items: stretch; }
            .filter-group input { width: 100% !important; margin: 0; }
            .filter-group button { width: 100%; margin-top: 5px; }
            
            #view-list > div:first-child { flex-direction: column; align-items: flex-start; gap: 15px; }
            #view-list .search-container { width: 100%; max-width: 100% !important; }
            #view-list button { width: 100%; justify-content: center; } 

            /* --- TABELAS RESPONSIVAS (CARD VIEW) --- */
            .table-container { border: none; background: transparent; overflow: visible; }
            .data-table { display: block; width: 100%; min-width: 0 !important; }
            .data-table thead { display: none; } 
            
            .data-table tbody { display: block; width: 100%; }
            .data-table tr { 
                display: block; 
                background: white; 
    
                border-radius: 12px; 
                box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
                border: 1px solid #e2e8f0;
                padding: 15px;
                position: relative; 
            }
            
            .data-table td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                padding: 8px 0; 
                border-bottom: 1px solid #f1f5f9; 
                text-align: right;
                font-size: 0.9rem;
            }
            .data-table td:last-child { border-bottom: none; }
            
            .data-table td::before { 
                content: attr(data-label); 
                font-weight: 700; 
                color: #64748b; 
                font-size: 0.8rem; 
                text-transform: uppercase;
                margin-right: 15px;
                text-align: left;
                flex-shrink: 0;
            }

            .data-table td:first-child { 
                display: block; 
                width: 100%; 
                text-align: left; 
                font-size: 1.1rem; 
                color: var(--dark); 
                border-bottom: 2px solid #f1f5f9; 
                margin-bottom: 8px; 
                padding-bottom: 8px;
                padding-right: 40px; 
            }
            .data-table td:first-child::before { display: none; }

            .data-table td.action-cell { 
                position: absolute; 
                top: 10px; 
                right: 5px; 
                width: auto; 
                border: none; 
                padding: 0;
                z-index: 2; 
            }
            .data-table td.action-cell::before { display: none; }
            .data-table td.action-cell i { font-size: 1.2rem; padding: 10px; color: #64748b; }

            /* --- CORREÇÃO VISUAL DO HISTÓRICO --- */
            #modal-history .data-table td {
                display: block; 
                text-align: left;
                padding: 12px 0;
            }
            #modal-history .data-table td::before {
                display: block; 
                margin-bottom: 5px;
                color: #94a3b8;
                font-size: 0.75rem;
            }
            
            #modal-history .data-table td[data-label="Projeto/Plano"] {
                 display: flex !important; 
                 flex-direction: column !important; 
                 align-items: flex-start !important;
                 gap: 4px; 
            }
            #modal-history .data-table td[data-label="Projeto/Plano"] > div {
                 width: 100%;
                 word-break: break-word;
            }

            .data-table td[data-label="Descrição"] { flex-direction: column; align-items: flex-start; text-align: left; gap: 5px; }
            
            /* --- MENU BOTTOM SHEET (Mobile) --- */
            .dropdown-menu.show {
                position: fixed !important;
                top: auto !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                min-width: 100% !important;
                border-radius: 16px 16px 0 0 !important;
                padding: 20px !important;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.3) !important;
                z-index: 9999999 !important;
                animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) !important;
                border: none !important;
            }
            
            .menu-backdrop {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999998;
                backdrop-filter: blur(2px);
            }
            .menu-backdrop.show { display: block; }

            .dropdown-menu.show button {
                padding: 15px !important;
                font-size: 1rem !important;
                border-bottom: 1px solid #f1f5f9;
            }
            .dropdown-menu.show button:last-child { border-bottom: none; }
            .dropdown-menu.show button i { margin-right: 15px; font-size: 1.1rem; }
        }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- COMPONENTES --- */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; white-space: nowrap; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; } 
        .btn-secondary { background: #94a3b8; color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .grid-2-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }

        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 5px; outline: none; font-size: 1rem; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
        .form-group { margin-bottom: 15px; }
        label { font-weight: 700; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Dashboard */
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; gap: 10px; align-items: center; background: white; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; }
        
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--dark); line-height: 1.2; }
        .stat-label { color: #64748b; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        
        /* Tabelas Desktop Base */
        .table-container { border-radius: 12px; background: white; overflow: hidden; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { text-align: left; padding: 15px; color: #64748b; border-bottom: 2px solid #e2e8f0; font-size: 0.8rem; text-transform: uppercase; font-weight: 700; white-space: nowrap; background: #f8fafc; }
        /* Classes para cores no Header */
        .th-success { color: var(--success) !important; }
        .th-danger { color: var(--danger) !important; }
        
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        .data-table tr.clickable:hover td { background: var(--bg-light); cursor: pointer; }
        
        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-top: 1px solid #f1f5f9; background: #f9fafb; }
        .pagination button { background: white; border: 1px solid #cbd5e1; padding: 5px 12px; border-radius: 6px; cursor: pointer; color: #64748b; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; white-space: nowrap; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #e0f2fe; color: #0369a1; }
        .badge-purple { background: #f3e8ff; color: #7e22ce; }
        .badge-gray { background: #f1f5f9; color: #475569; }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #login-screen { position: fixed; inset: 0; background: var(--dark); z-index: 2500; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(3px); padding: 20px; }
        .modal-box { background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow-y: auto; }
        
        /* MENU DROPDOWN */
        .dropdown-menu { 
            position: absolute; 
            background: white; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            display: none; 
            z-index: 999999; 
            border-radius: 8px; 
            min-width: 170px; 
            overflow: hidden;
            flex-direction: column;
            padding: 8px 0; 
            animation: fadeIn 0.2s;
        }
        .dropdown-menu.show { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .dropdown-menu button {
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            padding: 10px 20px; 
            font-size: 0.9rem;
            color: #334155;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px; 
            transition: background 0.1s;
            border-radius: 0;
        }
        .dropdown-menu button:hover { background-color: #f1f5f9; }
        .dropdown-menu button[style*="color:var(--danger)"] { color: var(--danger) !important; }
        .dropdown-menu button[style*="color:var(--danger)"] i { color: var(--danger) !important; }

        .search-container { position: relative; width: 300px; }
        .search-container i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-container input { padding-left: 40px; margin: 0; }

        /* Blocos de informação na modal */
        .info-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .info-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #64748b;
            text-transform: uppercase;
            display: block;
            margin-bottom: 2px;
        }
        .info-value {
            font-size: 0.95rem;
            color: #1e293b;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <div style="font-weight: 600; color: var(--primary);">Processando...</div>
    </div>
    
    <div id="menu-backdrop" class="menu-backdrop" onclick="closeAllMenus()"></div>

    <div id="login-screen">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center; padding: 40px 30px;">
            
            <div style="margin-bottom: 10px;">
                <svg fill="currentColor" width="70%" version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 200.7 37" style="enable-background:new 0 0 200.7 37; color: var(--primary);" xml:space="preserve">
                    <path id="Caminho_7003" d="M106,17.1h-9v2.4c0,0.8,0.6,1.4,1.4,1.4h5v1.2c-1.4,2.4-4,3.9-6.8,3.7c-4,0.2-7.3-2.9-7.5-6.9 c0-0.2,0-0.4,0-0.7c0-4.4,3-7.5,7.3-7.5c2.4,0,4.7,1.1,6,3.1l0.2,0.3l4.5-1.2l-0.3-0.5c-2.1-3.8-6.1-6.1-10.4-6 c-3.1,0-6.2,1.2-8.4,3.4c-2.3,2.3-3.5,5.3-3.5,8.5c0,3.2,1.2,6.3,3.5,8.5c2.2,2.2,5.3,3.4,8.4,3.4c0.1,0,0.2,0,0.3,0h0.1l0.1,0 c2.6-0.1,5.1-1,7.1-2.7c1.3-1.1,2.4-2.5,3.1-4.1l0-0.1v-4.8C107.3,17.8,106.7,17.1,106,17.1"></path>
                    <path id="Caminho_7004" d="M141.6,26.2c-4.3,0-7.3-3.1-7.3-7.5s3-7.5,7.3-7.5c4.3,0,7.4,3.1,7.4,7.5S145.9,26.2,141.6,26.2 M141.6,6.8c-3.1,0-6.2,1.2-8.4,3.4c-2.3,2.3-3.5,5.3-3.5,8.5c0,3.2,1.2,6.3,3.5,8.5c2.2,2.2,5.3,3.4,8.4,3.4c3.1,0,6.2-1.2,8.4-3.4 c2.3-2.3,3.5-5.3,3.5-8.5c0-3.2-1.2-6.3-3.5-8.5C147.8,8,144.7,6.8,141.6,6.8"></path>
                    <path id="Caminho_7005" d="M153.6,8.6v2.8h7.1v18.7h4.4V11.4h5.7c0.8,0,1.4-0.6,1.4-1.4V7.2h-17.2C154.2,7.2,153.6,7.9,153.6,8.6"></path>
                    <path id="Caminho_7006" d="M175.8,8.6v21.5h3c0.8,0,1.4-0.6,1.4-1.4V7.2h-3C176.4,7.2,175.8,7.9,175.8,8.6"></path>
                    <path id="Caminho_7007" d="M193.3,16.5c-0.3-0.1-0.5-0.2-0.8-0.3c-2.4-0.8-4.5-1.4-4.5-2.9c0-1.9,1.9-2.5,3.7-2.5 c2.1-0.1,4,1.4,4.4,3.5l0.1,0.5l3-0.8c0.6-0.2,0.9-0.7,0.9-1.3c0-0.2,0-0.3-0.1-0.4c0,0,0,0,0-0.1c0,0,0,0,0-0.1 c-1.4-3.3-4.6-5.3-8.2-5.2c-4.7,0-8.3,2.8-8.3,6.6c0,4.2,3.9,5.6,6.3,6.4c0.4,0.1,0.7,0.2,1.1,0.3c2.7,0.8,5.3,1.6,5.3,3.6 c0,1.6-1.6,2.8-4,2.8c-2.4,0.2-4.6-1.5-5-3.9l-0.1-0.5l-3.2,0.9c-0.5,0.2-0.8,0.7-0.8,1.3c0,0.2,0,0.4,0.1,0.5 c1.4,3.7,4.9,6,8.8,5.8c5.1,0,8.7-2.9,8.7-7C200.7,18.8,196.4,17.5,193.3,16.5"></path>
                    <path id="Caminho_7008" d="M72.3,14.1l3.5,7.3h-7L72.3,14.1z M73.7,7.2h-2.9L59.5,30.2h4c0.5,0,1-0.3,1.2-0.8l1.7-3.6 c0.1-0.1,0.2-0.2,0.4-0.2h10.6c0.1,0,0.3,0.1,0.3,0.2l1.8,3.7c0.2,0.4,0.7,0.7,1.2,0.7h4L73.8,7.5L73.7,7.2z"></path>
                    <path id="Caminho_7009" d="M127.5,14.8c0-4.6-3.4-7.5-8.9-7.5h-6.3c-0.8,0-1.4,0.6-1.4,1.4v20.1c0,0.8,0.6,1.4,1.4,1.4h3V11.4h3.6 c2.5,0,4,1.2,4,3.3s-1.4,3.3-4,3.3h-2.7l7.1,11.4c0,0,0,0,0,0c0.3,0.4,0.7,0.6,1.2,0.6h4.2l-5.5-8.8 C125.9,20.3,127.6,17.6,127.5,14.8"></path>
                    <path id="Caminho_7010" d="M30.9,26.1l0.6-1c0.4-0.7,1.1-1.1,1.9-1.1h12.2l0,0c-1.2-2.2-2.4-4.3-3.6-6.5H30.2 c-0.8,0-1.5,0.4-1.9,1.1l-0.6,1.1l-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1H6.9l-3.6,6.5l0,0h25.1c0.8,0,1.5-0.4,1.9-1.1 C30.5,26.8,30.7,26.4,30.9,26.1"></path>
                    <path id="Caminho_7011" d="M26.1,17.4l0.6-1.1c0.4-0.7,1.1-1.1,1.9-1.1h12.2l0,0c-1.2-2.2-2.4-4.4-3.6-6.5H25.4 c-0.8,0-1.5,0.4-1.9,1.1c-0.2,0.4-0.4,0.7-0.6,1.1l-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1h-8.7c-1.2,2.2-2.4,4.4-3.6,6.5 c-1.8,3.3,0,0,0,0h15.5c0.8,0,1.5-0.4,1.9-1.1L26.1,17.4"></path>
                    <path id="Caminho_7012" d="M21.3,8.7l0.6-1.1c0.4-0.7,1.1-1.1,1.9-1.1h12.1c0,0,0,0,0,0c0,0,0,0,0,0L33,1.1C32.6,0.4,31.8,0,31,0 H20.2c-0.8,0-1.5,0.4-1.9,1.1c-1.8,3.2-3.6,6.5-5.4,9.7c0,0,0,0,0,0c0,0,0,0,0,0h5.8c0.8,0,1.5-0.4,1.9-1.1L21.3,8.7"></path>
                    <path id="Caminho_7013" d="M51,33.8l-4.2-7.7H35c-0.8,0-1.6,0.4-2,1.2l-0.6,1c-0.2,0.4-0.4,0.7-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1 H2.1l0,0l-1.8,3.3c-0.6,1.1-0.2,2.4,0.9,3C1.5,36.9,1.8,37,2.2,37H49c1.2,0,2.2-1,2.2-2.2C51.2,34.4,51.1,34.1,51,33.8"></path>
                </svg>
            </div>
            <p style="color: #64748b; margin-bottom: 25px;">Sistema de Gestão de Qualidade</p>
            <input type="email" id="log-email" placeholder="Email *" required style="margin-bottom: 10px;">
            <input type="password" id="log-pass" placeholder="Senha *" required onkeydown="handleLoginKey(event)" style="margin-bottom: 20px;">
            <button class="btn btn-primary" style="width:100%; padding: 12px;" onclick="doLogin()">Entrar</button>
        </div>
    </div>

    <div id="mobile-header">
        <div style="font-weight:bold; font-size:1.2rem; color:white; display: flex; align-items: center; gap: 10px; width: 170px;">
            <svg fill="currentColor" width="70%" version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 200.7 37" style="enable-background:new 0 0 200.7 37;" xml:space="preserve">
                <path id="Caminho_7003" d="M106,17.1h-9v2.4c0,0.8,0.6,1.4,1.4,1.4h5v1.2c-1.4,2.4-4,3.9-6.8,3.7c-4,0.2-7.3-2.9-7.5-6.9 c0-0.2,0-0.4,0-0.7c0-4.4,3-7.5,7.3-7.5c2.4,0,4.7,1.1,6,3.1l0.2,0.3l4.5-1.2l-0.3-0.5c-2.1-3.8-6.1-6.1-10.4-6 c-3.1,0-6.2,1.2-8.4,3.4c-2.3,2.3-3.5,5.3-3.5,8.5c0,3.2,1.2,6.3,3.5,8.5c2.2,2.2,5.3,3.4,8.4,3.4c0.1,0,0.2,0,0.3,0h0.1l0.1,0 c2.6-0.1,5.1-1,7.1-2.7c1.3-1.1,2.4-2.5,3.1-4.1l0-0.1v-4.8C107.3,17.8,106.7,17.1,106,17.1"></path>
                <path id="Caminho_7004" d="M141.6,26.2c-4.3,0-7.3-3.1-7.3-7.5s3-7.5,7.3-7.5c4.3,0,7.4,3.1,7.4,7.5S145.9,26.2,141.6,26.2 M141.6,6.8c-3.1,0-6.2,1.2-8.4,3.4c-2.3,2.3-3.5,5.3-3.5,8.5c0,3.2,1.2,6.3,3.5,8.5c2.2,2.2,5.3,3.4,8.4,3.4c3.1,0,6.2-1.2,8.4-3.4 c2.3-2.3,3.5-5.3,3.5-8.5c0-3.2-1.2-6.3-3.5-8.5C147.8,8,144.7,6.8,141.6,6.8"></path>
                <path id="Caminho_7005" d="M153.6,8.6v2.8h7.1v18.7h4.4V11.4h5.7c0.8,0,1.4-0.6,1.4-1.4V7.2h-17.2C154.2,7.2,153.6,7.9,153.6,8.6"></path>
                <path id="Caminho_7006" d="M175.8,8.6v21.5h3c0.8,0,1.4-0.6,1.4-1.4V7.2h-3C176.4,7.2,175.8,7.9,175.8,8.6"></path>
                <path id="Caminho_7007" d="M193.3,16.5c-0.3-0.1-0.5-0.2-0.8-0.3c-2.4-0.8-4.5-1.4-4.5-2.9c0-1.9,1.9-2.5,3.7-2.5 c2.1-0.1,4,1.4,4.4,3.5l0.1,0.5l3-0.8c0.6-0.2,0.9-0.7,0.9-1.3c0-0.2,0-0.3-0.1-0.4c0,0,0,0,0-0.1c0,0,0,0,0-0.1 c-1.4-3.3-4.6-5.3-8.2-5.2c-4.7,0-8.3,2.8-8.3,6.6c0,4.2,3.9,5.6,6.3,6.4c0.4,0.1,0.7,0.2,1.1,0.3c2.7,0.8,5.3,1.6,5.3,3.6 c0,1.6-1.6,2.8-4,2.8c-2.4,0.2-4.6-1.5-5-3.9l-0.1-0.5l-3.2,0.9c-0.5,0.2-0.8,0.7-0.8,1.3c0,0.2,0,0.4,0.1,0.5 c1.4,3.7,4.9,6,8.8,5.8c5.1,0,8.7-2.9,8.7-7C200.7,18.8,196.4,17.5,193.3,16.5"></path>
                <path id="Caminho_7008" d="M72.3,14.1l3.5,7.3h-7L72.3,14.1z M73.7,7.2h-2.9L59.5,30.2h4c0.5,0,1-0.3,1.2-0.8l1.7-3.6 c0.1-0.1,0.2-0.2,0.4-0.2h10.6c0.1,0,0.3,0.1,0.3,0.2l1.8,3.7c0.2,0.4,0.7,0.7,1.2,0.7h4L73.8,7.5L73.7,7.2z"></path>
                <path id="Caminho_7009" d="M127.5,14.8c0-4.6-3.4-7.5-8.9-7.5h-6.3c-0.8,0-1.4,0.6-1.4,1.4v20.1c0,0.8,0.6,1.4,1.4,1.4h3V11.4h3.6 c2.5,0,4,1.2,4,3.3s-1.4,3.3-4,3.3h-2.7l7.1,11.4c0,0,0,0,0,0c0.3,0.4,0.7,0.6,1.2,0.6h4.2l-5.5-8.8 C125.9,20.3,127.6,17.6,127.5,14.8"></path>
                <path id="Caminho_7010" d="M30.9,26.1l0.6-1c0.4-0.7,1.1-1.1,1.9-1.1h12.2l0,0c-1.2-2.2-2.4-4.3-3.6-6.5H30.2 c-0.8,0-1.5,0.4-1.9,1.1l-0.6,1.1l-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1H6.9l-3.6,6.5l0,0h25.1c0.8,0,1.5-0.4,1.9-1.1 C30.5,26.8,30.7,26.4,30.9,26.1"></path>
                <path id="Caminho_7011" d="M26.1,17.4l0.6-1.1c0.4-0.7,1.1-1.1,1.9-1.1h12.2l0,0c-1.2-2.2-2.4-4.4-3.6-6.5H25.4 c-0.8,0-1.5,0.4-1.9,1.1c-0.2,0.4-0.4,0.7-0.6,1.1l-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1h-8.7c-1.2,2.2-2.4,4.4-3.6,6.5 c-1.8,3.3,0,0,0,0h15.5c0.8,0,1.5-0.4,1.9-1.1L26.1,17.4"></path>
                <path id="Caminho_7012" d="M21.3,8.7l0.6-1.1c0.4-0.7,1.1-1.1,1.9-1.1h12.1c0,0,0,0,0,0c0,0,0,0,0,0L33,1.1C32.6,0.4,31.8,0,31,0 H20.2c-0.8,0-1.5,0.4-1.9,1.1c-1.8,3.2-3.6,6.5-5.4,9.7c0,0,0,0,0,0c0,0,0,0,0,0h5.8c0.8,0,1.5-0.4,1.9-1.1L21.3,8.7"></path>
                <path id="Caminho_7013" d="M51,33.8l-4.2-7.7H35c-0.8,0-1.6,0.4-2,1.2l-0.6,1c-0.2,0.4-0.4,0.7-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1 H2.1l0,0l-1.8,3.3c-0.6,1.1-0.2,2.4,0.9,3C1.5,36.9,1.8,37,2.2,37H49c1.2,0,2.2-1,2.2-2.2C51.2,34.4,51.1,34.1,51,33.8"></path>
            </svg>
        </div>
        <i class="fas fa-bars" style="font-size:1.5rem; cursor:pointer;" onclick="toggleMobileSidebar()"></i>
    </div>
    <div id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <nav id="sidebar" class="hidden">
        <div class="brand">
            <span style="color: white; width: 170px;">
                <svg fill="currentColor" width="70%" version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 200.7 37" style="enable-background:new 0 0 200.7 37;" xml:space="preserve">
                    <path id="Caminho_7003" d="M106,17.1h-9v2.4c0,0.8,0.6,1.4,1.4,1.4h5v1.2c-1.4,2.4-4,3.9-6.8,3.7c-4,0.2-7.3-2.9-7.5-6.9 c0-0.2,0-0.4,0-0.7c0-4.4,3-7.5,7.3-7.5c2.4,0,4.7,1.1,6,3.1l0.2,0.3l4.5-1.2l-0.3-0.5c-2.1-3.8-6.1-6.1-10.4-6 c-3.1,0-6.2,1.2-8.4,3.4c-2.3,2.3-3.5,5.3-3.5,8.5c0,3.2,1.2,6.3,3.5,8.5c2.2,2.2,5.3,3.4,8.4,3.4c0.1,0,0.2,0,0.3,0h0.1l0.1,0 c2.6-0.1,5.1-1,7.1-2.7c1.3-1.1,2.4-2.5,3.1-4.1l0-0.1v-4.8C107.3,17.8,106.7,17.1,106,17.1"></path>
                    <path id="Caminho_7004" d="M141.6,26.2c-4.3,0-7.3-3.1-7.3-7.5s3-7.5,7.3-7.5c4.3,0,7.4,3.1,7.4,7.5S145.9,26.2,141.6,26.2 M141.6,6.8c-3.1,0-6.2,1.2-8.4,3.4c-2.3,2.3-3.5,5.3-3.5,8.5c0,3.2,1.2,6.3,3.5,8.5c2.2,2.2,5.3,3.4,8.4,3.4c3.1,0,6.2-1.2,8.4-3.4 c2.3-2.3,3.5-5.3,3.5-8.5c0-3.2-1.2-6.3-3.5-8.5C147.8,8,144.7,6.8,141.6,6.8"></path>
                    <path id="Caminho_7005" d="M153.6,8.6v2.8h7.1v18.7h4.4V11.4h5.7c0.8,0,1.4-0.6,1.4-1.4V7.2h-17.2C154.2,7.2,153.6,7.9,153.6,8.6"></path>
                    <path id="Caminho_7006" d="M175.8,8.6v21.5h3c0.8,0,1.4-0.6,1.4-1.4V7.2h-3C176.4,7.2,175.8,7.9,175.8,8.6"></path>
                    <path id="Caminho_7007" d="M193.3,16.5c-0.3-0.1-0.5-0.2-0.8-0.3c-2.4-0.8-4.5-1.4-4.5-2.9c0-1.9,1.9-2.5,3.7-2.5 c2.1-0.1,4,1.4,4.4,3.5l0.1,0.5l3-0.8c0.6-0.2,0.9-0.7,0.9-1.3c0-0.2,0-0.3-0.1-0.4c0,0,0,0,0-0.1c0,0,0,0,0-0.1 c-1.4-3.3-4.6-5.3-8.2-5.2c-4.7,0-8.3,2.8-8.3,6.6c0,4.2,3.9,5.6,6.3,6.4c0.4,0.1,0.7,0.2,1.1,0.3c2.7,0.8,5.3,1.6,5.3,3.6 c0,1.6-1.6,2.8-4,2.8c-2.4,0.2-4.6-1.5-5-3.9l-0.1-0.5l-3.2,0.9c-0.5,0.2-0.8,0.7-0.8,1.3c0,0.2,0,0.4,0.1,0.5 c1.4,3.7,4.9,6,8.8,5.8c5.1,0,8.7-2.9,8.7-7C200.7,18.8,196.4,17.5,193.3,16.5"></path>
                    <path id="Caminho_7008" d="M72.3,14.1l3.5,7.3h-7L72.3,14.1z M73.7,7.2h-2.9L59.5,30.2h4c0.5,0,1-0.3,1.2-0.8l1.7-3.6 c0.1-0.1,0.2-0.2,0.4-0.2h10.6c0.1,0,0.3,0.1,0.3,0.2l1.8,3.7c0.2,0.4,0.7,0.7,1.2,0.7h4L73.8,7.5L73.7,7.2z"></path>
                    <path id="Caminho_7009" d="M127.5,14.8c0-4.6-3.4-7.5-8.9-7.5h-6.3c-0.8,0-1.4,0.6-1.4,1.4v20.1c0,0.8,0.6,1.4,1.4,1.4h3V11.4h3.6 c2.5,0,4,1.2,4,3.3s-1.4,3.3-4,3.3h-2.7l7.1,11.4c0,0,0,0,0,0c0.3,0.4,0.7,0.6,1.2,0.6h4.2l-5.5-8.8 C125.9,20.3,127.6,17.6,127.5,14.8"></path>
                    <path id="Caminho_7010" d="M30.9,26.1l0.6-1c0.4-0.7,1.1-1.1,1.9-1.1h12.2l0,0c-1.2-2.2-2.4-4.3-3.6-6.5H30.2 c-0.8,0-1.5,0.4-1.9,1.1l-0.6,1.1l-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1H6.9l-3.6,6.5l0,0h25.1c0.8,0,1.5-0.4,1.9-1.1 C30.5,26.8,30.7,26.4,30.9,26.1"></path>
                    <path id="Caminho_7011" d="M26.1,17.4l0.6-1.1c0.4-0.7,1.1-1.1,1.9-1.1h12.2l0,0c-1.2-2.2-2.4-4.4-3.6-6.5H25.4 c-0.8,0-1.5,0.4-1.9,1.1c-0.2,0.4-0.4,0.7-0.6,1.1l-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1h-8.7c-1.2,2.2-2.4,4.4-3.6,6.5 c-1.8,3.3,0,0,0,0h15.5c0.8,0,1.5-0.4,1.9-1.1L26.1,17.4"></path>
                    <path id="Caminho_7012" d="M21.3,8.7l0.6-1.1c0.4-0.7,1.1-1.1,1.9-1.1h12.1c0,0,0,0,0,0c0,0,0,0,0,0L33,1.1C32.6,0.4,31.8,0,31,0 H20.2c-0.8,0-1.5,0.4-1.9,1.1c-1.8,3.2-3.6,6.5-5.4,9.7c0,0,0,0,0,0c0,0,0,0,0,0h5.8c0.8,0,1.5-0.4,1.9-1.1L21.3,8.7"></path>
                    <path id="Caminho_7013" d="M51,33.8l-4.2-7.7H35c-0.8,0-1.6,0.4-2,1.2l-0.6,1c-0.2,0.4-0.4,0.7-0.6,1.1c-0.4,0.7-1.1,1.1-1.9,1.1 H2.1l0,0l-1.8,3.3c-0.6,1.1-0.2,2.4,0.9,3C1.5,36.9,1.8,37,2.2,37H49c1.2,0,2.2-1,2.2-2.2C51.2,34.4,51.1,34.1,51,33.8"></path>
                </svg>
            </span>
            <i class="fas fa-bars toggle-btn" onclick="toggleSidebarDesktop()"></i>
        </div>
        <ul class="menu">
            <li onclick="navTo('dashboard')" id="menu-dash"><i class="fas fa-chart-line"></i> <span>Dashboard</span></li>
            <li onclick="navTo('projects')" id="menu-proj"><i class="fas fa-project-diagram"></i> <span>Projetos</span></li>
            <li onclick="navTo('profile')" id="menu-prof"><i class="fas fa-user"></i> <span>Perfil</span></li>
            
            <li onclick="doLogout()" id="menu-logout" style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 20px;">
                <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
            </li>
        </ul>
        <div class="user-panel">
            <img src="" id="sidebar-avatar" class="user-avatar">
            <div class="user-info" style="color: white;">
                <div style="font-weight:bold; font-size: 0.9rem;" id="sidebar-name">User</div>
                <div style="font-size:0.75rem; opacity: 0.8;">QA Analyst</div>
            </div>
        </div>
    </nav>

    <main id="main" class="hidden">
        
        <div id="view-dashboard" class="view-section">
            <div class="dash-header">
                <h2 style="margin:0; color: var(--dark); font-size: 1.5rem;">Dashboard</h2>
                <div class="filter-group">
                    <span style="font-size: 0.85rem; font-weight: 600; color:#64748b;">Período:</span>
                    <input type="date" id="dash-start">
                    <span style="color:#cbd5e1">até</span>
                    <input type="date" id="dash-end">
                    <button class="btn btn-primary" onclick="loadDashboard()"><i class="fas fa-filter"></i></button>
                </div>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div class="dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <div class="stat-card" style="border-color: #3b82f6;">
                    <div class="stat-val" id="d-users">0</div>
                    <div class="stat-label">Usuários</div>
                </div>
                    <div class="stat-card" style="border-color: #3b82f6;">
                        <div class="stat-val" style="color: #3b82f6" id="p-total">0</div>
                        <div class="stat-label">Execuções</div>
                    </div>
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-val" style="color: #10b981" id="p-sucesso">0</div>
                        <div class="stat-label">Sucessos</div>
                    </div>
                    <div class="stat-card" style="border-color: #ef4444;">
                        <div class="stat-val" style="color: #ef4444" id="p-bugs">0</div>
                        <div class="stat-label">Bugs</div>
                    </div>
                </div>
            </div>

            <div class="dash-grid">
                <div class="stat-card" style="border-color: #059669;">
                    <div class="stat-val" id="d-projs">0</div>
                    <div class="stat-label">Projetos</div>
                </div>
                <div class="stat-card" style="border-color: #059669;">
                    <div class="stat-val" id="d-plans">0</div>
                    <div class="stat-label">Planos</div>
                </div>
                <div class="stat-card" style="border-color: #059669;">
                    <div class="stat-val" id="d-scenarios">0</div>
                    <div class="stat-label">Cenários</div>
                </div>
<div class="stat-card" style="border-color: #7e22ce;">
                        <div class="stat-val" style="color: #7e22ce"><span id="d-auto">0</span>%</div>
                        <div class="stat-label">Automatizado</div>
                    </div>
                    <div class="stat-card" style="border-color: #475569;">
                        <div class="stat-val" style="color: #475569"><span id="d-manual">0</span>%</div>
                        <div class="stat-label">Manual</div>
                    </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-area" style="color: var(--primary)"></i> Evolução Diária</h3>
                <div style="height: 300px; position: relative;"><canvas id="chartEvolution"></canvas></div>
            </div>

            <div class="grid-2-cols">
                <div class="card">
                    <h3>Projetos (Testes vs Bugs)</h3>
                    <div style="max-height: 400px; overflow-y: auto;" class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Projeto</th><th style="text-align:center">Total</th><th style="text-align:center" class="th-success">Sucesso</th><th style="text-align:center" class="th-danger">Bugs</th></tr></thead>
                            <tbody id="dash-projects-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Produtividade da Equipe</h3>
                    <div style="max-height: 400px; overflow-y: auto;" class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Analista</th><th style="text-align:center">Total</th><th style="text-align:center" class="th-success">Sucesso</th><th style="text-align:center" class="th-danger">Bugs</th></tr></thead>
                            <tbody id="dash-users-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-list" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1; min-width: 200px;">
                    <div id="breadcrumb" style="font-size: 0.85rem; font-weight: bold; margin-bottom: 5px;"></div>
                    <h2 id="list-title" style="margin:0; color: var(--dark);">Lista</h2>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; width: 100%; md:width: auto; justify-content: flex-end;">
                    <div class="search-container" style="flex-grow: 1; max-width: 400px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="table-search" placeholder="Buscar..." onkeyup="filterTable()">
                    </div>
                    <div style="display:flex; gap:5px; flex-wrap: wrap; width: 100%; md:width: auto;">
                        <button class="btn btn-secondary hidden" id="btn-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                        <button class="btn btn-primary" id="btn-new" onclick="openForm()"><i class="fas fa-plus"></i> Novo</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead><tr id="table-head"></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
                <div id="empty-msg" style="padding: 40px; text-align: center; color: #94a3b8;" class="hidden">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                    Nenhum registro encontrado.
                </div>
                <div id="pagination" class="pagination hidden">
                    <button id="btn-prev" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <span id="page-info" style="font-size: 0.85rem; font-weight: bold; color: #64748b;">Pg 1</span>
                    <button id="btn-next" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div id="view-form" class="view-section hidden">
            <div class="card" style="max-width: 700px; margin: 0 auto;">
                <h2 id="form-title" style="margin-top:0">Novo Item</h2>
                <div id="form-fields"></div>
                <div style="text-align: right; margin-top: 25px; display:flex; justify-content: flex-end; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeForm()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveItem()">Salvar</button>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view-section hidden">
            <div class="card" style="max-width: 500px; margin: 0 auto;">
                <h2 style="margin-top:0">Meu Perfil</h2>
                <div class="form-group"><label>Nome *</label><input type="text" id="p-nome" required></div>
                <div class="form-group"><label>Email</label><input type="text" id="p-email" readonly disabled style="background:#DEDEDE;"></div>
                <div class="form-group"><label>Senha *</label><input type="password" id="p-senha" required></div>
                <div class="form-group"><label>Foto URL</label><input type="text" id="p-foto"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="updateProfile()">Atualizar Dados</button>
            </div>
        </div>

        <div id="modal-move" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div style="padding: 20px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0">Mover Cenário</h3>
                    <i class="fas fa-times" style="cursor:pointer; padding: 5px;" onclick="document.getElementById('modal-move').classList.add('hidden')"></i>
                </div>
                <div style="padding: 20px;">
                    <p style="color:#64748b; font-size:0.9rem; margin-top:0;">Selecione o novo destino:</p>
                    <div class="form-group"><label>Projeto</label><select id="move-project" onchange="loadMovePlans()"><option value="">Carregando...</option></select></div>
                    <div class="form-group"><label>Plano</label><select id="move-plan"><option value="">Selecione Projeto</option></select></div>
                </div>
                <div style="padding: 20px; border-top: 1px solid #eee; text-align: right; background: #f9fafb;">
                    <button class="btn btn-secondary" onclick="document.getElementById('modal-move').classList.add('hidden')">Cancelar</button>
                    <button class="btn btn-primary" onclick="confirmMove()">Mover</button>
                </div>
            </div>
        </div>

        <div id="modal-execute" class="modal-overlay hidden">
            <div class="modal-box">
                <div style="padding: 20px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-shrink: 0;">
                    <h3 style="margin:0">Executar</h3>
                    <i class="fas fa-times" style="cursor:pointer; padding: 5px;" onclick="closeModal()"></i>
                </div>
                <div style="padding: 20px; overflow-y: auto; flex-grow: 1;">
                    <div class="info-block">
                        <span class="info-label">Projeto</span>
                        <div class="info-value" id="exec-proj"></div>
                    </div>
                    <div class="info-block">
                        <span class="info-label">Plano de Teste</span>
                        <div class="info-value" id="exec-plan"></div>
                    </div>
                    <div class="info-block">
                        <span class="info-label">Cenário</span>
                        <div class="info-value" id="exec-name"></div>
                    </div>

                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 20px; border: 1px solid #bae6fd;">
                        <label style="display:block; margin-bottom:5px; color: #0284c7;">Requisitos</label>
                        <span id="exec-reqs" style="white-space: pre-wrap; color: #0369a1;"></span>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:5px;">Passos</label>
                        <span id="exec-steps" style="white-space: pre-wrap;"></span>
                    </div>

                    <div style="background: #fff7ed; padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 20px; border: 1px solid #ffedd5;">
                         <label style="display:block; margin-bottom:5px; color: #9a3412;">Resultado Esperado</label>
                         <span id="exec-expected" style="white-space: pre-wrap; color: #9a3412;"></span>
                    </div>

                    <div class="form-group"><label>Status *</label><select id="exec-status" required><option value="Sucesso">✅ Sucesso</option><option value="Bug">❌ Bug / Falha</option></select></div>
                    <div class="form-group"><label>Resultado Obtido * (**bold**, - list)</label><textarea id="exec-actual" required rows="3"></textarea></div>
                    
                    <div class="form-group"><label>Jira (Link)</label><input type="url" id="exec-jira" placeholder="https://jira.exemplo.com/browse/QA-123"></div>
                    
                    <div class="form-group"><label>Observações</label><textarea id="exec-obs" rows="2"></textarea></div>
                    <div class="form-group"><label>Evidências (Imagens)</label><input type="file" id="exec-files" multiple accept="image/*"></div>
                </div>
                <div style="padding: 20px; border-top: 1px solid #eee; text-align: right; background: #f9fafb; flex-shrink: 0;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button class="btn btn-success" onclick="confirmExecution()">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="modal-history" class="modal-overlay hidden">
            <div class="modal-box">
                <div style="padding: 20px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; font-size: 1.1rem;" id="hist-title">Histórico</h3>
                    <i class="fas fa-times" style="cursor:pointer; padding: 5px;" onclick="document.getElementById('modal-history').classList.add('hidden')"></i>
                </div>
                <div class="table-container" style="max-height: 60vh; overflow-y: auto; border:none; border-radius:0;">
                    <table class="data-table">
                        <thead><tr><th>Data</th><th>Projeto / Plano</th><th>Cenário</th><th>Status</th></tr></thead>
                        <tbody id="hist-body"></tbody>
                    </table>
                </div>
                <div id="hist-pagination" class="pagination hidden">
                    <button id="btn-hist-prev" onclick="changeHistoryPage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <span id="page-hist-info">Pg 1</span>
                    <button id="btn-hist-next" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

    </main>

   <script>
        // Use o seu URL de API aqui
        const API_URL = "https://script.google.com/macros/s/AKfycbxaGGsYNt_OWCsQd3HIizuGIwJu9fmsBRT8q7NmFcjFPAoecdnJLCn3sh1XrN8Vb5ovXA/exec"; 

        let state = { user: null, view: 'dashboard', level: 'projects', parentId: null, grandParentId: null, parentName: null, grandParentName: null, data: [], currentItem: null, currentPage: 1, itemsPerPage: 30, movingId: null, historyData: [], historyPage: 1 };

        window.onload = () => {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('dash-start').valueAsDate = firstDay;
            document.getElementById('dash-end').valueAsDate = lastDay;
        };

        function handleLoginKey(e) { if(e.key === 'Enter') doLogin(); }
        async function doLogin() {
            const email = document.getElementById('log-email').value.trim();
            const pass = document.getElementById('log-pass').value.trim();
            
            // 1. VALIDAÇÃO DE OBRIGATORIEDADE PARA LOGIN
            if (!email || !pass) {
                alert("Email e Senha são obrigatórios para login.");
                return;
            }
            
            toggleLoader(true);
            const res = await api({ acao: 'login', email, senha: pass });
            toggleLoader(false);
            if(res.status === 'sucesso') {
                state.user = res.data.user;
                document.getElementById('login-screen').classList.add('hidden');
                if(window.innerWidth > 768) document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main').classList.remove('hidden');
                document.getElementById('sidebar-name').innerText = state.user.nome;
                document.getElementById('sidebar-avatar').src = state.user.foto || `https://ui-avatars.com/api/?name=${state.user.nome}&background=059669&color=fff`;
                document.getElementById('p-nome').value = state.user.nome;
                document.getElementById('p-email').value = state.user.email;
                document.getElementById('p-foto').value = state.user.foto || '';
                navTo('dashboard');
            } else alert(res.mensagem);
        }
        
        // NOVA FUNÇÃO DE LOGOUT
        function doLogout() {
            // Limpa o estado local (opcional, mas boa prática)
            state.user = null;
            // Redireciona para a tela de login (simulado recarregando a página)
            location.reload(); 
        }

        function toggleSidebarDesktop() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function toggleMobileSidebar() { const sb = document.getElementById('sidebar'); const overlay = document.getElementById('sidebar-overlay'); sb.classList.remove('hidden'); sb.classList.toggle('mobile-open'); overlay.classList.toggle('show'); }

        function navTo(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.menu li').forEach(e => e.classList.remove('active'));
            if(window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('mobile-open'); document.getElementById('sidebar-overlay').classList.remove('show'); }
            if(view === 'dashboard') { document.getElementById('view-dashboard').classList.remove('hidden'); document.getElementById('menu-dash').classList.add('active'); loadDashboard(); } 
            else if(view === 'projects') { document.getElementById('view-list').classList.remove('hidden'); document.getElementById('menu-proj').classList.add('active'); state.level = 'projects'; state.parentId = null; state.currentPage = 1; loadList(); } 
            else if(view === 'profile') { 
                document.getElementById('view-profile').classList.remove('hidden'); 
                document.getElementById('menu-prof').classList.add('active'); 
                // Garante que os campos atuais do usuário logado estão no formulário ao abrir o perfil
                if(state.user) {
                    document.getElementById('p-nome').value = state.user.nome;
                    document.getElementById('p-email').value = state.user.email;
                    document.getElementById('p-foto').value = state.user.foto || '';
                    document.getElementById('p-senha').value = ''; // Sempre limpa o campo senha por segurança
                }
            }
        }

        async function loadDashboard(background = false) {
            const start = document.getElementById('dash-start').value;
            const end = document.getElementById('dash-end').value;
            if(!background) toggleLoader(true);
            const res = await api({ acao: 'dashboard', inicio: start, fim: end });
            if(!background) toggleLoader(false);
            if(res.status === 'sucesso') {
                const k = res.data.kpis;
                const totais = res.data.totaisPeriodo;
                
                document.getElementById('d-projs').innerText = k.projects; document.getElementById('d-plans').innerText = k.plans;
                document.getElementById('d-scenarios').innerText = k.scenarios; document.getElementById('d-users').innerText = k.users;
                
                document.getElementById('d-auto').innerText = k.percAuto; document.getElementById('d-manual').innerText = k.percManual;
                
                if(totais) {
                    document.getElementById('p-total').innerText = totais.total;
                    document.getElementById('p-sucesso').innerText = totais.sucesso;
                    document.getElementById('p-bugs').innerText = totais.bugs;
                }

                const tbProj = document.getElementById('dash-projects-body'); tbProj.innerHTML = '';
                res.data.projetos.forEach(p => { tbProj.innerHTML += `<tr><td data-label="Projeto"><b>${p.nome}</b></td><td data-label="Total" style="text-align:center">${p.total}</td><td data-label="Sucesso" style="text-align:center; color: var(--success)">${p.sucesso}</td><td data-label="Bugs" style="text-align:center; color: var(--danger); font-weight:bold">${p.falha}</td></tr>`; });
                
                const tbUser = document.getElementById('dash-users-body'); tbUser.innerHTML = '';
                res.data.usuarios.forEach(u => {
                    let avatar = u.foto || `https://ui-avatars.com/api/?name=${u.nome}&background=ddd&color=333`;
                    tbUser.innerHTML += `<tr class="clickable" onclick="openUserHistory('${u.email}', '${u.nome}')"><td data-label="Analista" style="display:flex; align-items:center; gap:10px;"><img src="${avatar}" style="width:30px; height:30px; border-radius:50%"><b>${u.nome}</b></td><td data-label="Total" style="text-align:center; font-weight:bold">${u.total}</td><td data-label="Sucesso" style="text-align:center;"><span class="badge badge-green">${u.sucesso}</span></td><td data-label="Bugs" style="text-align:center;"><span class="badge badge-red">${u.bugs}</span></td></tr>`;
                });
                renderEvolutionChart(res.data.timeline);
            }
        }

        function renderEvolutionChart(timelineData) {
            const ctx = document.getElementById('chartEvolution');
            if (window.chartEvol && typeof window.chartEvol.destroy === 'function') window.chartEvol.destroy();
            window.chartEvol = new Chart(ctx, {
                type: 'line',
                data: { labels: timelineData.labels, datasets: [{ label: 'Sucessos', data: timelineData.sucesso, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }, { label: 'Bugs / Falhas', data: timelineData.bug, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3 }] },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { position: 'top' } } }
            });
        }

        async function openUserHistory(email, name) {
            document.getElementById('hist-title').innerText = "Histórico: " + name;
            document.getElementById('modal-history').classList.remove('hidden');
            document.getElementById('hist-body').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Carregando...</td></tr>';
            toggleLoader(true);
            const res = await api({ acao: 'listarHistorico', email: email });
            toggleLoader(false);
            if(res.status === 'sucesso') { state.historyData = res.data; state.historyPage = 1; renderHistoryTable(); } 
            else { alert("Erro ao carregar histórico"); }
        }

        function renderHistoryTable() {
            const tb = document.getElementById('hist-body'); tb.innerHTML = '';
            const pagDiv = document.getElementById('hist-pagination');
            const data = state.historyData;
            if(data.length > 30) { pagDiv.classList.remove('hidden'); document.getElementById('page-hist-info').innerText = `Pg ${state.historyPage}`; document.getElementById('btn-hist-prev').disabled = state.historyPage === 1; document.getElementById('btn-hist-next').disabled = state.historyPage === Math.ceil(data.length / 30); } else { pagDiv.classList.add('hidden'); }
            const start = (state.historyPage - 1) * 30; const end = start + 30; const items = data.slice(start, end);
            if(items.length === 0) { tb.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Nenhum registro.</td></tr>'; return; }
            items.forEach(i => {
                let badge = i.status === 'Sucesso' ? '<span class="badge badge-green">Sucesso</span>' : '<span class="badge badge-red">Bug</span>';
                tb.innerHTML += `<tr><td data-label="Data">${i.data}</td><td data-label="Projeto/Plano"><div style="font-weight:bold">${i.projeto}</div><div style="font-size:0.8rem; color:#64748b">${i.plano}</div></td><td data-label="Cenário"><div>${i.cenario}</div></td><td data-label="Status">${badge}</td></tr>`;
            });
        }
        function changeHistoryPage(delta) { state.historyPage += delta; renderHistoryTable(); }

        function updateBreadcrumb() { const bc = document.getElementById('breadcrumb'); if(state.level === 'projects') bc.innerHTML = `<span class="breadcrumb-active">Projetos</span>`; else if(state.level === 'plans') bc.innerHTML = `<span class="breadcrumb-link" onclick="state.level='projects'; loadList()">Projetos</span> > <span class="breadcrumb-active">Planos</span>`; else if(state.level === 'scenarios') bc.innerHTML = `<span class="breadcrumb-link" onclick="state.level='projects'; loadList()">Projetos</span> > <span class="breadcrumb-link" onclick="state.level='plans'; state.parentId=state.grandParentId; state.parentName=state.grandParentName; loadList()">Planos</span> > <span class="breadcrumb-active">Cenários</span>`; }
        function goBack() { if(state.level === 'scenarios') { state.level = 'plans'; state.parentId = state.grandParentId; state.parentName = state.grandParentName; } else if(state.level === 'plans') { state.level = 'projects'; } state.currentPage = 1; loadList(); }
        async function loadList() { let payload = {}; let title = '', btnText = ''; if(state.level === 'projects') { payload = { acao: 'listarProjetos' }; title = 'Projetos'; btnText = 'Novo Projeto'; document.getElementById('btn-back').classList.add('hidden'); } else if(state.level === 'plans') { payload = { acao: 'listarPlanos', projetoId: state.parentId }; title = state.parentName; btnText = 'Novo Plano'; document.getElementById('btn-back').classList.remove('hidden'); } else { payload = { acao: 'listarCenarios', planoId: state.parentId }; title = state.parentName + ' / Cenários'; btnText = 'Novo Cenário'; document.getElementById('btn-back').classList.remove('hidden'); } document.getElementById('list-title').innerText = title; updateBreadcrumb(); document.getElementById('btn-new').innerHTML = `<i class="fas fa-plus"></i> ${btnText}`; document.getElementById('table-search').value = ''; toggleLoader(true); const res = await api(payload); toggleLoader(false); state.data = res.data || []; state.currentPage = 1; renderTable(); }
        
        function renderTable(filteredData = null) { 
            const dataToRender = filteredData || state.data; const tb = document.getElementById('table-body'); tb.innerHTML = ''; const th = document.getElementById('table-head'); th.innerHTML = ''; const pagDiv = document.getElementById('pagination'); 
            if (dataToRender.length > state.itemsPerPage) { pagDiv.classList.remove('hidden'); document.getElementById('page-info').innerText = `Pg ${state.currentPage}`; document.getElementById('btn-prev').disabled = state.currentPage === 1; document.getElementById('btn-next').disabled = state.currentPage === Math.ceil(dataToRender.length / state.itemsPerPage); } else { pagDiv.classList.add('hidden'); } 
            const start = (state.currentPage - 1) * state.itemsPerPage; const end = start + state.itemsPerPage; const pageItems = dataToRender.slice(start, end); 
            if(state.level === 'projects') th.innerHTML = '<th>Nome</th><th>Planos</th><th>Cenários</th><th>% Auto</th><th>% Manual</th><th></th>'; 
            else if(state.level === 'plans') th.innerHTML = '<th>Nome</th><th>Descrição</th><th>Cenários</th><th></th>'; 
            else th.innerHTML = '<th>Cenário</th><th>Tipo</th><th>Execuções</th><th>Bugs</th><th>Sucesso</th><th></th>'; 
            if(pageItems.length === 0) return document.getElementById('empty-msg').classList.remove('hidden'); document.getElementById('empty-msg').classList.add('hidden'); 
            pageItems.forEach(item => { 
                let tr = document.createElement('tr'); tr.classList.add('clickable'); 
                tr.onclick = (e) => { if(e.target.closest('.dropdown-menu') || e.target.closest('.fa-ellipsis-v')) return; if(state.level === 'projects') drillDown(item.id, item.nome); else if(state.level === 'plans') drillDown(item.id, item.nome); else if(state.level === 'scenarios') openExec(item.id); }; 
                let html = ''; 
                if(state.level === 'projects') html = `<td data-label="Nome"><b>${item.nome}</b></td><td data-label="Planos"><span class="badge badge-info">${item.qtd_planos}</span></td><td data-label="Cenários"><span class="badge badge-green">${item.qtd_cenarios}</span></td><td data-label="% Auto"><span class="badge badge-purple">${item.perc_auto}%</span></td><td data-label="% Manual"><span class="badge badge-gray">${item.perc_manual}%</span></td>`; 
                else if(state.level === 'plans') html = `<td data-label="Nome"><b>${item.nome}</b></td><td data-label="Descrição">${item.descricao||''}</td><td data-label="Cenários"><span class="badge badge-info">${item.qtd_cenarios}</span></td>`; 
                else { let st = item.stats; let tipoBadge = `<span class="badge" style="background:#f1f5f9; color:#64748b">${item.tipo_execucao || 'N/A'}</span>`; html = `<td data-label="Cenário"><b>${item.nome}</b></td><td data-label="Tipo">${tipoBadge}</td><td data-label="Execuções">${st.total}</td><td data-label="Bugs"><span class="badge badge-red">${st.falha}</span></td><td data-label="Sucesso"><span class="badge badge-green">${st.sucesso}</span></td>`; } 
                let btnMain = state.level === 'scenarios' ? `<button onclick="openExec('${item.id}')" style="color:var(--success)"><i class="fas fa-play"></i> Executar</button>` : `<button onclick="drillDown('${item.id}', '${item.nome}')"><i class="fas fa-folder-open"></i> Abrir</button>`; 
                let btnMove = state.level === 'scenarios' ? `<button onclick="openMove('${item.id}')"><i class="fas fa-exchange-alt"></i> Mover</button>` : ''; 
                html += `<td class="action-cell" style="text-align:right;"><i class="fas fa-ellipsis-v" style="cursor:pointer;padding:10px 20px;color:#94a3b8" onclick="toggleMenu(event,'${item.id}')"></i><div id="menu-${item.id}" class="dropdown-menu">${btnMain}${btnMove}<button onclick="editItem('${item.id}')"><i class="fas fa-edit"></i> Editar</button><button onclick="deleteItem('${item.id}')" style="color:var(--danger)"><i class="fas fa-trash"></i> Excluir</button></div></td>`; tr.innerHTML = html; tb.appendChild(tr); 
            }); 
        }
        
        function changePage(delta) { state.currentPage += delta; filterTable(); }
        function drillDown(id, name) { 
            if(state.level === 'projects') { 
                state.level = 'plans'; 
                state.grandParentId = state.parentId; 
                state.grandParentName = state.parentName; // Undefined no nível 1, mas ok
                state.parentId = id; 
                state.parentName = name; 
            } else if(state.level === 'plans') { 
                state.level = 'scenarios'; 
                state.grandParentId = state.parentId; 
                state.grandParentName = state.parentName; // Nome do Projeto
                state.parentId = id; 
                state.parentName = state.parentName + " / " + name; // Projeto / Plano
            } 
            state.currentPage = 1; 
            loadList(); 
        }
        function filterTable() { const term = document.getElementById('table-search').value.toLowerCase(); renderTable(state.data.filter(i => i.nome.toLowerCase().includes(term))); }
        
        function toggleMenu(e, id) {
            e.stopPropagation();
            const menu = document.getElementById('menu-' + id);
            closeAllMenus();
            if (menu && !menu.classList.contains('show')) {
                menu.classList.add('show');
                const parentCell = menu.closest('.action-cell');
                if(parentCell) parentCell.style.zIndex = '10000001';
                if (window.innerWidth > 768) {
                    const rect = e.target.getBoundingClientRect();
                    menu.style.position = 'fixed';
                    menu.style.top = (rect.bottom + 5) + 'px';
                    menu.style.left = (rect.right - 170) + 'px';
                    menu.style.right = 'auto'; 
                    menu.style.zIndex = '999999';
                } else {
                    document.getElementById('menu-backdrop').classList.add('show');
                    menu.style.top = ''; menu.style.left = ''; menu.style.position = '';
                }
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.dropdown-menu').forEach(d => { d.classList.remove('show'); });
            document.getElementById('menu-backdrop').classList.remove('show');
            document.querySelectorAll('.action-cell').forEach(el => el.style.zIndex = '');
        }

        window.addEventListener('scroll', () => { if(window.innerWidth > 768) closeAllMenus(); }, true);
        window.onclick = function(e) { if(!e.target.matches('.fa-ellipsis-v')) closeAllMenus(); }
        
        async function openMove(id) { state.movingId = id; document.getElementById('modal-move').classList.remove('hidden'); const res = await api({ acao: 'listarProjetos' }); const sel = document.getElementById('move-project'); sel.innerHTML = '<option value="">Selecione o Projeto</option>'; res.data.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.nome}</option>`); }
        async function loadMovePlans() { const pId = document.getElementById('move-project').value; const sel = document.getElementById('move-plan'); sel.innerHTML = '<option value="">Carregando...</option>'; if(!pId) return; const res = await api({ acao: 'listarPlanos', projetoId: pId }); sel.innerHTML = '<option value="">Selecione o Plano</option>'; res.data.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.nome}</option>`); }
        async function confirmMove() { const novoPlano = document.getElementById('move-plan').value; if(!novoPlano) return alert("Selecione um plano"); toggleLoader(true); const res = await api({ acao: 'moverCenario', cenarioId: state.movingId, novoPlanoId: novoPlano }); toggleLoader(false); if(res.status === 'sucesso') { alert("Cenário movido com sucesso!"); document.getElementById('modal-move').classList.add('hidden'); loadList(); } else alert("Erro ao mover"); }

        function openForm() { 
            document.getElementById('view-list').classList.add('hidden'); 
            document.getElementById('view-form').classList.remove('hidden'); 
            let context = state.level === 'projects' ? 'Projeto' : state.level === 'plans' ? 'Plano' : 'Cenário'; 
            document.getElementById('form-title').innerText = `${state.currentItem ? 'Editar' : 'Novo'} ${context}`; 
            const c = document.getElementById('form-fields'); 
            c.innerHTML = `<div class="form-group"><label>Nome *</label><input id="f-nome" required></div>`; 
            
            if(state.level !== 'scenarios') { 
                // Projeto ou Plano: Nome* e Descrição*
                c.innerHTML += `<div class="form-group"><label>Descrição *</label><textarea id="f-desc" required></textarea></div>`; 
            } else { 
                // Cenário: Nome*, Requisitos*, Tipo*, Passos*, Resultado Esperado*
                c.innerHTML += `
                    <div class="form-group"><label>Requisitos *</label><textarea id="f-reqs" rows="3" required></textarea></div>
                    <div class="form-group"><label>Tipo de Execução *</label><select id="f-tipo" required><option value="Manual">Manual</option><option value="Automatizado">Automatizado</option><option value="Manual e Automatizado">Manual e Automatizado</option></select></div>
                    <div class="form-group"><label>Passos *</label><textarea id="f-passos" rows="4" required></textarea></div>
                    <div class="form-group"><label>Resultado Esperado *</label><textarea id="f-res" rows="2" required></textarea></div>`; 
            } 
            
            if(state.currentItem) { 
                document.getElementById('f-nome').value = state.currentItem.nome; 
                if(document.getElementById('f-desc')) document.getElementById('f-desc').value = state.currentItem.descricao || ''; 
                if(document.getElementById('f-reqs')) document.getElementById('f-reqs').value = state.currentItem.requisitos || ''; 
                if(document.getElementById('f-tipo')) document.getElementById('f-tipo').value = state.currentItem.tipo_execucao || 'Manual'; 
                if(document.getElementById('f-passos')) document.getElementById('f-passos').value = state.currentItem.passo_a_passo || ''; 
                if(document.getElementById('f-res')) document.getElementById('f-res').value = state.currentItem.resultado_esperado || ''; 
            } 
        }

        function closeForm() { state.currentItem = null; document.getElementById('view-form').classList.add('hidden'); document.getElementById('view-list').classList.remove('hidden'); }
        async function saveItem() { 
            let item = { nome: document.getElementById('f-nome').value.trim() }; 
            let aba = state.level === 'projects' ? 'Projetos' : state.level === 'plans' ? 'Planos' : 'Cenarios'; 
            
            // Validação de Nome (Obrigatório em todos os níveis)
            if (!item.nome) { alert("O campo Nome é obrigatório."); return; }
            
            if(state.level !== 'scenarios') { 
                // Projeto ou Plano: Descrição Obrigatória
                item.descricao = document.getElementById('f-desc').value.trim();
                if (!item.descricao) { alert("O campo Descrição é obrigatório."); return; }
                if(!state.currentItem && state.level === 'plans') item.projeto_id = state.parentId; 
            }
            
            if(state.level === 'scenarios') { 
                // Cenário: Vários campos obrigatórios
                item.requisitos = document.getElementById('f-reqs').value.trim();
                item.tipo_execucao = document.getElementById('f-tipo').value; 
                item.passo_a_passo = document.getElementById('f-passos').value.trim(); 
                item.resultado_esperado = document.getElementById('f-res').value.trim(); 
                
                if (!item.requisitos) { alert("O campo Requisitos é obrigatório."); return; }
                if (!item.passo_a_passo) { alert("O campo Passos é obrigatório."); return; }
                if (!item.resultado_esperado) { alert("O campo Resultado Esperado é obrigatório."); return; }
                
                if(!state.currentItem) item.plano_id = state.parentId; 
            } 
            
            toggleLoader(true); 
            const res = await api({ acao: state.currentItem ? 'editar' : 'criar', aba, item, id: state.currentItem?.id }); 
            toggleLoader(false); 
            if(res.status === 'sucesso') { closeForm(); loadList(); loadDashboard(true); } 
            else alert("Erro ao salvar: " + res.mensagem);
        }
        function editItem(id) { state.currentItem = state.data.find(i => i.id == id); openForm(); }
        async function deleteItem(id) { if(confirm("Excluir item?")) { let aba = state.level === 'projects' ? 'Projetos' : state.level === 'plans' ? 'Planos' : 'Cenarios'; toggleLoader(true); await api({ acao: 'excluir', aba, id }); toggleLoader(false); loadList(); loadDashboard(true); } }
        
        function openExec(id) { 
            state.executingItem = state.data.find(i => i.id == id); 
            
            let projName = state.grandParentName || "N/A";
            let planName = state.parentName ? state.parentName.split(' / ').pop() : "N/A";
            
            document.getElementById('exec-proj').innerText = projName;
            document.getElementById('exec-plan').innerText = planName;
            document.getElementById('exec-name').innerText = state.executingItem.nome; 
            
            document.getElementById('exec-reqs').innerText = state.executingItem.requisitos || 'Sem Requisitos';
            document.getElementById('exec-steps').innerText = state.executingItem.passo_a_passo || 'Sem passos'; 
            document.getElementById('exec-expected').innerText = state.executingItem.resultado_esperado || 'Não especificado'; 
            
            // Limpa campos para nova execução
            document.getElementById('exec-status').value = 'Sucesso';
            document.getElementById('exec-actual').value = ''; 
            document.getElementById('exec-obs').value = ''; 
            document.getElementById('exec-jira').value = '';
            document.getElementById('exec-files').value = ''; 

            // ATUALIZA RÓTULOS (HTML) - A obrigatoriedade foi tratada no HTML e validada no JS
            // <div class="form-group"><label>Status *</label><select id="exec-status" required>...
            // <div class="form-group"><label>Resultado Obtido * (**bold**, - list)</label><textarea id="exec-actual" required rows="3"></textarea></div>
            // <div class="form-group"><label>Jira (Link) *</label><input type="url" id="exec-jira" placeholder="https://jira.exemplo.com/browse/QA-123"></div>
            
            document.getElementById('modal-execute').classList.remove('hidden'); 
        }
        
        function closeModal() { document.getElementById('modal-execute').classList.add('hidden'); }
        async function confirmExecution() { 
            const status = document.getElementById('exec-status').value.trim(); 
            const actual = document.getElementById('exec-actual').value.trim(); 
            const obs = document.getElementById('exec-obs').value.trim(); 
            const jira = document.getElementById('exec-jira').value.trim(); 
            const files = document.getElementById('exec-files').files; 
            
            // 4. VALIDAÇÃO DE OBRIGATORIEDADE PARA EXECUÇÃO
            if (!status) { alert("O campo Status é obrigatório."); return; }
            if (!actual) { alert("O campo Resultado Obtido é obrigatório."); return; }
            if (!jira) { alert("O campo Jira (Link) é obrigatório."); return; }
            
            toggleLoader(true); 
            let fileData = []; 
            if(files.length > 0) { fileData = await Promise.all(Array.from(files).map(f => new Promise(r => { const reader = new FileReader(); reader.onload = () => r({name: f.name, data: reader.result}); reader.readAsDataURL(f); }))); } 
            let urls = []; 
            if (fileData.length > 0) { const upRes = await api({ acao: 'uploadMultiplo', arquivos: fileData }); if(upRes.status === 'sucesso') urls = upRes.data.urls; } 
            
            const res = await api({ 
                acao: 'registrarExecucao', 
                cenarioId: state.executingItem.id, 
                projetoId: state.grandParentId, 
                planoId: state.parentId, 
                status: status, 
                resultadoObtido: actual, 
                obs: obs, 
                jira: jira, 
                evidencias: urls.join(', '), 
                usuario: state.user.email 
            }); 
            
            toggleLoader(false); 
            if(res.status === 'sucesso') { 
                closeModal(); 
                
                let projName = state.grandParentName || "N/A";
                let planName = state.parentName ? state.parentName.split(' / ').pop() : "N/A";

                generatePDF({ 
                    cenario: state.executingItem.nome, 
                    projeto: projName,
                    plano: planName,
                    requisitos: state.executingItem.requisitos,
                    passos: state.executingItem.passo_a_passo, 
                    esperado: state.executingItem.resultado_esperado, 
                    status: status, 
                    obtido: actual, 
                    obs: obs, 
                    jira: jira,
                    evidenciasUrls: urls, 
                    evidenciasData: fileData, 
                    usuario: state.user.nome 
                }); 
                loadList(); 
                loadDashboard(true); 
            } else alert("Erro ao registrar execução: " + res.mensagem);
        }

        // --- FUNÇÃO generatePDF CORRIGIDA E ESTILIZADA ---
        function generatePDF(data) { 
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            const resultColor = data.status === 'Sucesso' ? '#10b981' : '#ef4444'; // Cor para o resultado (verde/vermelho)
            const now = new Date();
            
            // Formatando Data e Hora
            const dateStr = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hour}h${minute}min`;
            
            // --- Variáveis de Layout PDF ---
            const FONT_BASE = 'helvetica';
            const FONT_NORMAL = 'normal';
            const FONT_BOLD = 'bold';
            
            const MARGIN_LEFT = 15;
            const MARGIN_RIGHT = 15;
            const WRAP_WIDTH = 210 - MARGIN_LEFT - MARGIN_RIGHT;
            
            const FONT_SIZE_TITLE = 16;
            const FONT_SIZE_CONTENT = 10; // Reduzido um pouco para melhor fluxo
            const FONT_SIZE_HEADER_LABEL = 10;
            const FONT_SIZE_HEADER_VALUE = 11;
            
            const LINE_HEIGHT_SM = 5.5; // Para detalhes do cabeçalho
            const LINE_HEIGHT_MD = 6; // Para conteúdo
            
            let y = 30; // Posição Y inicial (abaixo do cabeçalho fixo)
            
            // --- HEADER FIXO (Topo Colorido) ---
            doc.setFillColor(resultColor); 
            doc.rect(0, 0, 210, 15, 'F'); // Retângulo mais fino para o topo
            doc.setTextColor('#ffffff'); 
            doc.setFontSize(13); 
            doc.setFont(FONT_BASE, FONT_BOLD); 
            doc.text("RELATÓRIO DE EXECUÇÃO - QA AGROTIS", 105, 10, { align: "center" }); 
            
            doc.setTextColor('#333333'); 
            
            // --- BLOCO DE INFORMAÇÕES (FUNDO CINZA E CANTOS ARREDONDADOS) ---
            
            const BLOCK_X = MARGIN_LEFT;
            const BLOCK_Y = y;
            const BLOCK_WIDTH = WRAP_WIDTH;
            const PADDING = 5; // Preenchimento interno do bloco
            const LABEL_WIDTH = 35; // Largura fixa para os rótulos (Data, Hora, etc)
            const INITIAL_Y = BLOCK_Y + PADDING + 4; // Começo do texto dentro do bloco
            let current_y = INITIAL_Y;
            
            // Dados para o bloco
            const headerData = [
                { label: "Data:", value: dateStr },
                { label: "Hora:", value: timeStr },
                { label: "Responsável:", value: data.usuario },
                { label: "Resultado:", value: data.status.toUpperCase() === 'SUCESSO' ? 'SUCESSO' : 'ERRO', color: data.status === 'Sucesso' ? '#065f46' : '#991b1b', bold: true },
                { label: "Projeto:", value: data.projeto },
                { label: "Plano de Teste:", value: data.plano },
                { label: "Cenário:", value: data.cenario }
            ];

            // 1. Desenha o Bloco (Fundo cinza claro e cantos arredondados)
            const blockHeight = (headerData.length * LINE_HEIGHT_SM) + (2 * PADDING) + 5; // Altura calculada
            doc.setFillColor('#f0f0f0'); 
            doc.roundedRect(BLOCK_X, BLOCK_Y, BLOCK_WIDTH, blockHeight, 3, 3, 'F');
            
            // 2. Adiciona as linhas de informação dentro do bloco
            headerData.forEach(item => {
                // Rótulo (Label)
                doc.setFontSize(FONT_SIZE_HEADER_LABEL);
                doc.setFont(FONT_BASE, FONT_BOLD); 
                doc.setTextColor('#555555');
                doc.text(item.label, BLOCK_X + PADDING, current_y); 
                
                // Valor (Value)
                doc.setFontSize(FONT_SIZE_HEADER_VALUE);
                doc.setFont(FONT_BASE, item.bold ? FONT_BOLD : FONT_NORMAL); 
                doc.setTextColor(item.color || '#333333');
                
                // Posição do valor (alinhamento forçado após a largura do rótulo)
                // Usando uma largura fixa para o alinhamento
                const valueX = BLOCK_X + PADDING + LABEL_WIDTH; 
                doc.text(item.value, valueX, current_y); 
                
                current_y += LINE_HEIGHT_SM;
            });
            
            y = BLOCK_Y + blockHeight + 8; // Atualiza a posição Y para começar o conteúdo após o bloco
            doc.setTextColor('#333333');
            
            // --- Funções Auxiliares (mantidas e ajustadas para novo y) ---
            
            // Função Helper para Títulos de Seção e Espaçamento
            const addSectionTitle = (title) => {
                y += 6; // Espaço acima
                if(y > 280) { doc.addPage(); y = 20; }
                
                doc.setFontSize(FONT_SIZE_TITLE);
                doc.setFont(FONT_BASE, FONT_BOLD); 
                doc.text(title.toUpperCase(), MARGIN_LEFT, y);
                y += 6; // Espaço após o título
                doc.setLineWidth(0.5);
                doc.setDrawColor('#cccccc');
                doc.line(MARGIN_LEFT, y - 1, MARGIN_LEFT + 60, y - 1); // Linha pequena para estilizar
                y += 4;
            }

            // Função Helper para conteúdo formatado (markdown/normal)
            const renderContent = (text, isLink = false, linkUrl = null) => {
                if(y > 280) { doc.addPage(); y = 20; }

                if (isLink && linkUrl) {
                    doc.setFontSize(FONT_SIZE_CONTENT);
                    doc.setFont(FONT_BASE, FONT_NORMAL); 
                    doc.setTextColor('#0000FF'); 
                    doc.textWithLink(text, MARGIN_LEFT, y, { url: linkUrl });
                    doc.setTextColor('#333333');
                    y += LINE_HEIGHT_MD;
                    return;
                }
                
                if (!text || text.trim() === "") { 
                    doc.setFontSize(FONT_SIZE_CONTENT);
                    doc.setFont(FONT_BASE, FONT_NORMAL); 
                    doc.setTextColor('#94a3b8'); // Cor cinza para N/A
                    doc.text("N/A", MARGIN_LEFT, y);
                    doc.setTextColor('#333333');
                    y += LINE_HEIGHT_MD;
                    return;
                }
                
                doc.setFontSize(FONT_SIZE_CONTENT);
                const lines = text.split('\n'); 
                
                lines.forEach(line => { 
                    if(y > 280) { doc.addPage(); y = 20; }
                    let prefix = ""; 
                    let cleanLine = line; 
                    let fontStyle = FONT_NORMAL;

                    if(line.trim().startsWith('-')) { prefix = "• "; cleanLine = line.trim().substring(1).trim(); } 
                    if(cleanLine.includes('**')) { fontStyle = FONT_BOLD; cleanLine = cleanLine.replace(/\*\*/g, ''); } 
                    
                    doc.setFont(FONT_BASE, fontStyle); 
                    const splitText = doc.splitTextToSize(prefix + cleanLine, WRAP_WIDTH); 
                    doc.text(splitText, MARGIN_LEFT, y); 
                    y += (splitText.length * LINE_HEIGHT_MD); 
                }); 
                y += 2; // Pequeno espaçamento entre blocos de conteúdo
            }; 
            
            // --- SEÇÕES DE CONTEÚDO ---

            // REQUISITOS
            addSectionTitle("REQUISITOS");
            renderContent(data.requisitos);

            // PASSO A PASSO
            addSectionTitle("PASSO A PASSO");
            renderContent(data.passos);

            // RESULTADO ESPERADO
            addSectionTitle("RESULTADO ESPERADO");
            renderContent(data.esperado);

            // RESULTADO OBTIDO
            addSectionTitle("RESULTADO OBTIDO");
            renderContent(data.obtido); 

            // JIRA ATENDIDO (Com Link)
            addSectionTitle("JIRA ATENDIDO");
            if (data.jira && data.jira.trim() !== "") {
                renderContent(data.jira, true, data.jira);
            } else {
                renderContent("N/A");
            }
            
            // OBSERVAÇÕES
            addSectionTitle("OBSERVAÇÕES");
            renderContent(data.obs); 

            // EVIDÊNCIAS ANEXAS
            if((data.evidenciasData && data.evidenciasData.length > 0) || (data.evidenciasUrls && data.evidenciasUrls.length > 0)) {
                
                addSectionTitle("EVIDÊNCIAS ANEXAS");
                
                // Evidências Anexadas (Imagens)
                data.evidenciasData.forEach(file => { 
                    if(y > 230) { doc.addPage(); y = 20; } // Adiciona página se a imagem não couber (ajustado para mais espaço)
                    try { 
                        const imgWidth = 80;
                        const imgHeight = 60;
                        doc.addImage(file.data, 'JPEG', MARGIN_LEFT, y, imgWidth, imgHeight); 
                        doc.setFontSize(8); 
                        doc.setFont(FONT_BASE, FONT_NORMAL); 
                        doc.text(file.name, MARGIN_LEFT, y + imgHeight + 3); 
                        y += imgHeight + 10; // Espaço após a imagem e o nome
                    } catch(e) { doc.setFontSize(10); doc.text("[Erro ao carregar imagem]", MARGIN_LEFT, y); y += 10; } 
                }); 
                
                // Links no Drive
                if(data.evidenciasUrls && data.evidenciasUrls.length > 0) { 
                    if(y > 270) { doc.addPage(); y = 20; } 
                    
                    doc.setFont(FONT_BASE, FONT_BOLD); 
                    doc.setFontSize(10);
                    doc.text("Links no Drive:", MARGIN_LEFT, y); 
                    y += 7; 
                    
                    doc.setFont(FONT_BASE, FONT_NORMAL); 
                    doc.setTextColor('#0000FF'); 
                    data.evidenciasUrls.forEach(link => { 
                        if(y > 280) { doc.addPage(); y = 20; }
                        doc.textWithLink("Abrir Arquivo", MARGIN_LEFT, y, { url: link }); 
                        y += 7; 
                    }); 
                    doc.setTextColor('#333333');
                } 
            }

            // --- NOME DO ARQUIVO ---
            const cleanName = (str) => (str || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '_').substring(0, 30);
            const fileName = `${cleanName(data.projeto)}_${cleanName(data.plano)}_${cleanName(data.cenario)}_${dateStr.replace(/\//g, '-')}_${cleanName(data.status)}.pdf`;

            doc.save(fileName); 
        }

        async function updateProfile() { 
            const nome = document.getElementById('p-nome').value.trim();
            const senha = document.getElementById('p-senha').value.trim();
            const foto = document.getElementById('p-foto').value.trim();
            const emailOriginal = state.user.email; // Email original é usado para identificação

            // 2. VALIDAÇÃO DE OBRIGATORIEDADE PARA PERFIL
            if (!nome || !senha) {
                alert("Nome e Senha são campos obrigatórios para atualização do perfil.");
                return;
            }

            const dados = { 
                acao: 'atualizarUsuario', 
                emailOriginal: emailOriginal, 
                // O email novo é o mesmo do original, mas enviamos para consistência (e a função do Apps Script espera 'novoEmail')
                novoEmail: emailOriginal, 
                novoNome: nome, 
                novaSenha: senha, 
                novaFoto: foto
            }; 
            
            toggleLoader(true); 
            const res = await api(dados); 
            toggleLoader(false); 

            if(res.status === 'sucesso') {
                // Atualiza o state.user localmente com o novo nome/foto
                state.user.nome = nome;
                state.user.foto = foto;
                // Atualiza Sidebar
                document.getElementById('sidebar-name').innerText = state.user.nome;
                document.getElementById('sidebar-avatar').src = state.user.foto || `https://ui-avatars.com/api/?name=${state.user.nome}&background=059669&color=fff`;

                alert("Perfil atualizado com sucesso!"); 
                // Não é necessário reload se o email não mudou. 
            } else {
                alert("Erro ao atualizar perfil: " + res.mensagem);
            }
        }
        function toggleLoader(show) { const l = document.getElementById('loader'); show ? l.classList.remove('hidden') : l.classList.add('hidden'); }
        async function api(data) { try { return await (await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) })).json(); } catch(e) { return { status: 'erro', mensagem: e.toString() }; } }
    </script>
    
    <div id="modal-execute" class="modal-overlay hidden">
        <div class="modal-box">
            <div style="padding: 20px; overflow-y: auto; flex-grow: 1;">
                <div class="form-group"><label>Status *</label><select id="exec-status" required><option value="Sucesso">✅ Sucesso</option><option value="Bug">❌ Bug / Falha</option></select></div>
                <div class="form-group"><label>Resultado Obtido * (**bold**, - list)</label><textarea id="exec-actual" required rows="3"></textarea></div>
                
                <div class="form-group"><label>Jira (Link) *</label><input type="url" id="exec-jira" placeholder="https://jira.exemplo.com/browse/QA-123" required></div>
                
                <div class="form-group"><label>Observações</label><textarea id="exec-obs" rows="2"></textarea></div>
                <div class="form-group"><label>Evidências (Imagens)</label><input type="file" id="exec-files" multiple accept="image/*"></div>
            </div>
            </div>
    </div>
</body>
</html>
